---
import type { VideoItem } from '~/data/media/video';
import MediaTooltip from './MediaTooltip.astro';

export interface Props {
  videos: VideoItem[];
  title?: string;
  description?: string;
}

const { 
  videos = [], 
  title = "Video Gallery", 
  description = "Watch performances, music videos, and collaborations" 
} = Astro.props as Props;

// Organize videos by category (inferred from title/content)
const organizeByCategory = (videos: VideoItem[]) => {
  const categories = {
    'Live Performances': [] as VideoItem[],
    'Official Videos': [] as VideoItem[],
    'Collaborations': [] as VideoItem[]
  };
  
  videos.forEach(video => {
    const title = video.title.toLowerCase();
    const notes = video.notes?.toLowerCase() || '';
    
    if (notes.includes('official') || notes.includes('cast recording')) {
      categories['Official Videos'].push(video);
    } else if (title.includes('live') || notes.includes('live')) {
      categories['Live Performances'].push(video);
    } else {
      categories['Collaborations'].push(video);
    }
  });
  
  return categories;
};

const categorizedVideos = organizeByCategory(videos);

// Get category badge styling
const getCategoryBadge = (category: string) => {
  const badges: Record<string, string> = {
    'Live Performances': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
    'Official Videos': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
    'Collaborations': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
  };
  return badges[category] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
};

// Extract artist name from title if possible
const extractArtist = (video: VideoItem): string | undefined => {
  // Common patterns: "Title - Artist" or "Artist - Title" 
  if (video.title.includes(' - ')) {
    const parts = video.title.split(' - ');
    if (parts.length >= 2) {
      // If second part looks like an artist name (contains common artist words)
      const secondPart = parts[1].toLowerCase();
      if (secondPart.includes('jeremy jordan') || 
          secondPart.includes('lindsay mendez') || 
          secondPart.includes('annaleigh ashford') ||
          secondPart.includes('meghann fahy')) {
        return parts[1];
      }
      // Otherwise assume first part might be artist
      const firstPart = parts[0].toLowerCase();
      if (firstPart.includes('jeremy jordan') || 
          firstPart.includes('lindsay mendez') || 
          firstPart.includes('annaleigh ashford') ||
          firstPart.includes('meghann fahy')) {
        return parts[0];
      }
    }
  }
  return undefined;
};
---

<section class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">

  {Object.entries(categorizedVideos).map(([category, categoryVideos], categoryIndex) => 
    categoryVideos.length > 0 && (
      <div class="mb-8">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 border-l-4 border-blue-500 pl-4">
          {category}
        </h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-5">
          {categoryVideos.map((video, index) => {
            const artist = extractArtist(video);
            const cleanTitle = artist ? video.title.replace(` - ${artist}`, '').replace(`${artist} - `, '') : video.title;
            
            return (
              <div class="group relative bg-white dark:bg-gray-900 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 overflow-hidden">
                <!-- Video Thumbnail with GLightbox -->
                <div class="relative aspect-video overflow-hidden bg-gray-900">
                  <a
                    href={`https://www.youtube.com/watch?v=${video.youtubeId}`}
                    class="glightbox glightbox-video-thumb block w-full h-full relative"
                    data-gallery={`video-gallery-${categoryIndex}`}
                    data-title={cleanTitle}
                    data-description={`${artist ? `by ${artist}` : ''}${video.notes ? ` â€¢ ${video.notes}` : ''}`}
                    data-type="video"
                    data-source="youtube"
                  >
                    <img
                      src={`https://img.youtube.com/vi/${video.youtubeId}/maxresdefault.jpg`}
                      alt={video.title}
                      class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                      loading="lazy"
                    />
                    
                    <!-- Play Button Overlay -->
                    <div class="glightbox-play-btn">
                      <svg fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                      </svg>
                    </div>

                    <!-- Category Badge -->
                    <div class="absolute top-3 left-3">
                      <span class={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getCategoryBadge(category)}`}>
                        {category.replace(' Videos', '').replace(' Performances', '')}
                      </span>
                    </div>

                    <!-- Duration Badge (Optional - would need to be added to data) -->
                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <span>YouTube</span>
                    </div>
                    
                    <!-- Enhanced Hover Tooltip -->
                    <MediaTooltip 
                      title={cleanTitle}
                      artist={artist}
                      description={video.notes}
                      category={category}
                      position="top"
                      className="hidden sm:block"
                    />
                  </a>
                </div>
                
                <!-- Video Info -->
                <div class="p-4">
                  <h4 class="font-semibold text-gray-900 dark:text-white text-base mb-1 line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-200">
                    {cleanTitle}
                  </h4>
                  
                  {artist && (
                    <p class="text-gray-700 dark:text-gray-200 text-sm mb-1 font-medium">
                      {artist}
                    </p>
                  )}
                  
                  {video.notes && (
                    <p class="text-gray-600 dark:text-gray-300 text-xs line-clamp-2 leading-relaxed">
                      {video.notes}
                    </p>
                  )}
                  
                  <!-- Click to watch hint -->
                  <div class="mt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <span class="text-blue-600 dark:text-blue-400 text-xs font-medium">
                      Click to watch
                    </span>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    )
  )}
</section>

<script>
  // Enhanced video gallery interaction
  class VideoGalleryGLightbox {
    constructor() {
      this.init();
    }
    
    init() {
      // Add additional interactivity if needed
      const videoCards = document.querySelectorAll('.group');
      
      videoCards.forEach(card => {
        // Add keyboard navigation
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const link = card.querySelector('.glightbox');
            if (link) {
              link.click();
            }
          }
        });
        
        // Make cards focusable
        const link = card.querySelector('.glightbox');
        if (link) {
          link.setAttribute('tabindex', '0');
        }
      });
      
      // Listen for GLightbox events to add custom behavior
      document.addEventListener('glightbox-slide-before-change', (e) => {
        console.log('Video gallery: Changing to slide', e.detail);
      });
    }
  }
  
  // Initialize video gallery enhancements
  const initVideoGallery = () => {
    if (document.querySelector('.glightbox-video-thumb')) {
      new VideoGalleryGLightbox();
    }
  };

  // Initialize with multiple fallbacks for Astro
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVideoGallery);
  } else {
    initVideoGallery();
  }
  
  window.addEventListener('load', initVideoGallery);
  document.addEventListener('astro:page-load', initVideoGallery);
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Enhanced hover effects for video cards */
  .group:hover {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }
  
  /* Smooth transitions for all interactive elements */
  .group,
  .group img,
  .group .glightbox-play-btn,
  .group h4,
  .group p {
    transition: all 0.3s ease;
  }
  
  /* Focus styles for accessibility */
  .glightbox:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
  
  .glightbox:focus .glightbox-play-btn {
    background: rgba(255, 255, 255, 1);
    transform: translate(-50%, -50%) scale(1.1);
  }
  
  /* Dark mode enhancements */
  @media (prefers-color-scheme: dark) {
    .group:hover {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
  }
  
  /* Mobile optimization */
  @media (max-width: 640px) {
    .glightbox-play-btn {
      width: 3rem;
      height: 3rem;
    }
    
    .glightbox-play-btn svg {
      width: 1.25rem;
      height: 1.25rem;
    }
  }
</style>